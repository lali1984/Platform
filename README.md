```markdown
# üìö –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π —Å–µ—Ä–≤–∏—Å–æ–≤

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∫–æ–¥–∞, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ö –∏ –ª–æ–≥–∏–∫–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è. –û–Ω —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ *—á—Ç–æ* –¥–µ–ª–∞–µ—Ç –∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å, –Ω–æ –∏ *–∫–∞–∫*, *–ø–æ—á–µ–º—É* –∏ *–≤ –∫–∞–∫–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏* –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ –º–µ–∂–¥—É –Ω–∏–º–∏.

---

## üîç –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –º–æ–¥–µ–ª—å

–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É **—Å–æ–±—ã—Ç–∏–π–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (Event-Driven Architecture, EDA)** —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞ **Outbox** –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö. –ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è: **–Ω–∏–∫–∞–∫–∏–µ –¥–≤–∞ —Å–µ—Ä–≤–∏—Å–∞ –Ω–µ –¥–æ–ª–∂–Ω—ã –Ω–∞–ø—Ä—è–º—É—é –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥ –¥—Ä—É–≥–∞**. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –æ–Ω–∏ –ø—É–±–ª–∏–∫—É—é—Ç —Å–æ–±—ã—Ç–∏—è –æ –ø—Ä–æ–∏–∑–æ—à–µ–¥—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö, –∞ –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã —Ä–µ–∞–≥–∏—Ä—É—é—Ç –Ω–∞ —ç—Ç–∏ —Å–æ–±—ã—Ç–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ.

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –†–æ–ª—å | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å |
|-----------|------|------------|----------------|
| **`auth-service`** | –ò—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–±—ã—Ç–∏–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –≤—Ö–æ–¥–∞ | NestJS + PostgreSQL | –°–æ–∑–¥–∞—ë—Ç `UserRegisteredEvent`, `UserLoggedIn`, `UserLoginFailed`. –ù–µ —Å–æ–∑–¥–∞—ë—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–≤–æ–µ–π –ë–î ‚Äî —Ç–æ–ª—å–∫–æ —É—á—ë—Ç–Ω—É—é –∑–∞–ø–∏—Å—å. |
| **`user-service`** | –ò—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–±—ã—Ç–∏–π –ø—Ä–æ—Ñ–∏–ª—è | NestJS + PostgreSQL | –°–æ–∑–¥–∞—ë—Ç `UserCreatedEvent` –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è. –†–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ `UserRegisteredEvent` –∏–∑ `auth-service` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ). |
| **`event-relay`** | –ú–æ—Å—Ç –º–µ–∂–¥—É –ë–î –∏ Kafka | Node.js + TypeORM + KafkaJS | –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã `outbox_events` –≤ `auth_db` –∏ `user_db`, –ø—É–±–ª–∏–∫—É–µ—Ç –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ Kafka. |
| **`bff-gateway`** | –ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏–π | Express + KafkaJS | –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Ç–æ–ø–∏–∫–∏ Kafka (`user.events`) –∏ –æ–∂–∏–¥–∞–µ—Ç `UserCreatedEvent`/`UserRegisteredEvent` –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. |
| **Kafka Cluster** | –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –±—Ä–æ–∫–µ—Ä —Å–æ–±—ã—Ç–∏–π | Confluent Kafka | –ï–¥–∏–Ω—ã–π –∫–∞–Ω–∞–ª –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π –º–µ–∂–¥—É –≤—Å–µ–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏. |

---

## üîÑ –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

### 1. –ü–æ—Ç–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`/api/auth/register`)

–≠—Ç–æ —Å–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π –∏ –∫—Ä–∏—Ç–∏—á–Ω—ã–π –ø–æ—Ç–æ–∫, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—â–∏–π –ø–æ–ª–Ω—É—é —Ü–µ–ø–æ—á–∫—É –æ—Ç HTTP-–∑–∞–ø—Ä–æ—Å–∞ –¥–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.

```mermaid
sequenceDiagram
    participant F as Frontend
    participant B as bff-gateway
    participant A as auth-service
    participant U as user-service
    participant R as event-relay
    participant K as Kafka

    F->>B: POST /api/auth/register {email, password, ...}
    B->>A: POST /register {email, password, ...} (HTTP)
    A->>A: –í–∞–ª–∏–¥–∞—Ü–∏—è, —Å–æ–∑–¥–∞–Ω–∏–µ User entity, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ auth_db.users
    A->>A: –ü—É–±–ª–∏–∫–∞—Ü–∏—è createUserRegisteredEvent –≤ outbox_events (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ)
    A-->>B: –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç —Å tokens –∏ userId
    B->>R: (–û–∂–∏–¥–∞–Ω–∏–µ) –°–ª—É—à–∞–µ—Ç —Ç–æ–ø–∏–∫ user.events —á–µ—Ä–µ–∑ KafkaConsumer
    R->>K: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —á–∏—Ç–∞–µ—Ç –∏–∑ auth_db.outbox_events –∏ –ø—É–±–ª–∏–∫—É–µ—Ç –≤ Kafka
    K->>R: –°–æ–±—ã—Ç–∏–µ UserRegisteredEvent –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ç–æ–ø–∏–∫ auth.events.registered.v1
    R->>U: (–†–µ–∞–∫—Ü–∏—è) user-service –º–æ–∂–µ—Ç –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ auth.events.registered.v1 –∏ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
    R->>B: KafkaConsumer –≤ bff-gateway –ø–æ–ª—É—á–∞–µ—Ç UserCreatedEvent –∏–∑ user.events.created.v1
    B->>U: GET /users/{userId} (HTTP) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    U->>U: –ü–æ–∏—Å–∫ –ø–æ ID –≤ user_db.user_profiles
    U-->>B: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç UserProfile
    B->>F: –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç —Å tokens + profile
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å**: `bff-gateway` –Ω–µ –∂–¥—ë—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ. –û–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ `auth-service`, –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã, –∞ –∑–∞—Ç–µ–º *–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ* –æ–∂–∏–¥–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è.
- **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å**: –ï—Å–ª–∏ `user-service` –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, `event-relay` –±—É–¥–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å –ø–æ–ø—ã—Ç–∫–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏—è –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –æ–Ω–æ –Ω–µ –±—É–¥–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∏–ª–∏ –Ω–µ –ø–æ–ø–∞–¥—ë—Ç –≤ DLQ (Dead Letter Queue).
- **–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å**: –ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞—ë—Ç—Å—è *–ø–æ—Å–ª–µ* —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ `auth-service`, —á—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Å–∏—Å—Ç–µ–º–µ.

---

### 2. –ü–æ—Ç–æ–∫ –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`/api/auth/login`)

–ë–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–π, –Ω–æ —Ç–∞–∫–∂–µ –≤–∞–∂–Ω—ã–π –ø–æ—Ç–æ–∫, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—â–∏–π —Ä–∞–±–æ—Ç—É —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º.

```mermaid
sequenceDiagram
    participant F as Frontend
    participant B as bff-gateway
    participant A as auth-service
    participant U as user-service
    participant C as Redis Cache

    F->>B: POST /api/auth/login {email, password}
    B->>C: GET user:{userId}:profile (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞)
    C-->>B: null (–∫—ç—à –ø—Ä–æ–º–∞—Ö)
    B->>A: POST /login {email, password} (HTTP)
    A->>A: –ü–æ–∏—Å–∫ –ø–æ email, –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ lastLoginAt
    A->>A: –ü—É–±–ª–∏–∫–∞—Ü–∏—è UserLoggedIn –≤ outbox_events
    A-->>B: –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç —Å tokens –∏ userId
    B->>U: GET /users/profile/{userId} (HTTP) —Å —Ç–æ–∫–µ–Ω–æ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    U->>U: –ü–æ–∏—Å–∫ –ø–æ ID –≤ user_db.user_profiles
    U-->>B: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç UserProfile
    B->>C: SET user:{userId}:profile (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à –Ω–∞ 5 –º–∏–Ω)
    B-->>F: –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç —Å tokens + profile
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: `bff-gateway` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π, —á—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ `user-service`.
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤**: `auth-service` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JWT, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è `bff-gateway` –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏ –≤—ã–∑–æ–≤–∞—Ö `user-service`.

---

### 3. –ü–æ—Ç–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è (`/api/users/{id}`)

–ü—Ä–∏–º–µ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –±–µ–∑ —É—á–∞—Å—Ç–∏—è —Å–æ–±—ã—Ç–∏–π.

```mermaid
sequenceDiagram
    participant F as Frontend
    participant B as bff-gateway
    participant U as user-service

    F->>B: PUT /api/users/{id} {firstName, avatarUrl}
    B->>U: PUT /users/{id} {firstName, avatarUrl} (HTTP)
    U->>U: –ü–æ–∏—Å–∫ –ø–æ ID, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ user_db.user_profiles
    U->>U: –ü—É–±–ª–∏–∫–∞—Ü–∏—è UserUpdatedEvent –≤ outbox_events
    U-->>B: –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º –ø—Ä–æ—Ñ–∏–ª–µ–º
    B-->>F: –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- **–ü—Ä—è–º–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è**: `bff-gateway` –≤—ã—Å—Ç—É–ø–∞–µ—Ç –∫–∞–∫ –ø—Ä–æ–∫—Å–∏, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—è –∑–∞–ø—Ä–æ—Å—ã –Ω–∞–ø—Ä—è–º—É—é –≤ `user-service`.
- **–°–æ–±—ã—Ç–∏—è –¥–ª—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏**: –•–æ—Ç—è —Å–∞–º –∑–∞–ø—Ä–æ—Å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π, `user-service` –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—É–±–ª–∏–∫—É–µ—Ç `UserUpdatedEvent`, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏–ª–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏) –º–æ–≥–ª–∏ –Ω–∞ –Ω–µ–≥–æ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å.

---

## üß© –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞

### `auth-service` ‚Äî –°–µ—Ä–≤–∏—Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

- **–Ø–¥—Ä–æ**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º —É—á—ë—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –≤—Ö–æ–¥, –≤—ã—Ö–æ–¥, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è, 2FA.
- **–•—Ä–∞–Ω–∏–ª–∏—â–µ**: PostgreSQL (`auth_db`). –°–æ–¥–µ—Ä–∂–∏—Ç —Ç–∞–±–ª–∏—Ü—ã `users`, `refresh_tokens`, `two_factor_secrets`.
- **–°–æ–±—ã—Ç–∏—è**: –ü—É–±–ª–∏–∫—É–µ—Ç `UserRegisteredEvent`, `UserLoggedIn`, `UserLoginFailed`. –≠—Ç–∏ —Å–æ–±—ã—Ç–∏—è –ø–∏—à—É—Ç—Å—è –≤ —Å–≤–æ—é —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É `outbox_events`.
- **–í–∞–∂–Ω–æ**: –ù–µ —Ö—Ä–∞–Ω–∏—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–º—è, –∞–≤–∞—Ç–∞—Ä, —Ç–µ–ª–µ—Ñ–æ–Ω). –≠—Ç–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å `user-service`.

### `user-service` ‚Äî –°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–º

- **–Ø–¥—Ä–æ**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ—Ñ–∏–ª—è: —Å–æ–∑–¥–∞–Ω–∏–µ, —á—Ç–µ–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, –ø–æ–∏—Å–∫.
- **–•—Ä–∞–Ω–∏–ª–∏—â–µ**: PostgreSQL (`user_db`). –°–æ–¥–µ—Ä–∂–∏—Ç —Ç–∞–±–ª–∏—Ü—ã `user_profiles`, `user_preferences`, `user_statistics`.
- **–°–æ–±—ã—Ç–∏—è**: –ü—É–±–ª–∏–∫—É–µ—Ç `UserCreatedEvent`, `UserUpdatedEvent`, `UserDeletedEvent`. –¢–∞–∫–∂–µ –º–æ–∂–µ—Ç *–ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å—Å—è* –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∏–∑ `auth-service`, –Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
- **–í–∞–∂–Ω–æ**: –ü–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–∑–∞–≤–∏—Å–∏–º –æ—Ç `auth-service` –≤ –ø–ª–∞–Ω–µ –ë–î. –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Å–≤—è–∑—å ‚Äî —á–µ—Ä–µ–∑ HTTP API –∏ Kafka.

### `bff-gateway` ‚Äî Backend-for-Frontend

- **–Ø–¥—Ä–æ**: –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è frontend. –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ `auth-service` –∏ `user-service` –≤ –µ–¥–∏–Ω—ã–π –æ—Ç–≤–µ—Ç.
- **–•—Ä–∞–Ω–∏–ª–∏—â–µ**: Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π –∏ —Ç–æ–∫–µ–Ω–æ–≤.
- **–°–æ–±—ã—Ç–∏—è**: **–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å**, –∞ –Ω–µ –∏–∑–¥–∞—Ç–µ–ª—å. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `KafkaEventWaiter` –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π `UserCreatedEvent`/`UserRegisteredEvent`, —á—Ç–æ–±—ã "–¥–æ–∂–¥–∞—Ç—å—Å—è" –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
- **–í–∞–∂–Ω–æ**: –≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç –¥–≤–æ–π–Ω—É—é —Ä–æ–ª—å: –æ–Ω –∏ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä, –∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏–π. –û–Ω "–∑–∞–∫—Ä—ã–≤–∞–µ—Ç" –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ä–∞–∑—Ä—ã–≤ –º–µ–∂–¥—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –∏ —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è frontend.

### `event-relay` ‚Äî –°–æ–±—ã—Ç–∏–π–Ω—ã–π —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä

- **–Ø–¥—Ä–æ**: –ú–µ—Ö–∞–Ω–∏–∑–º –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π. –≠—Ç–æ "–º–æ—Å—Ç" –º–µ–∂–¥—É —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–º–∏ –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –∏ Kafka.
- **–•—Ä–∞–Ω–∏–ª–∏—â–µ**: –ù–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞. –ß–∏—Ç–∞–µ—Ç –∏–∑ `outbox_events` –≤ `auth_db` –∏ `user_db`.
- **–°–æ–±—ã—Ç–∏—è**: **–ò–∑–¥–∞—Ç–µ–ª—å**. –ß–∏—Ç–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü `outbox_events` –∏ –ø—É–±–ª–∏–∫—É–µ—Ç –∏—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ Kafka-—Ç–æ–ø–∏–∫–∏.
- **–í–∞–∂–Ω–æ**: –†–µ–∞–ª–∏–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω Outbox, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É "–¥–≤—É—Ö—Ñ–∞–∑–Ω–æ–π —Ñ–∏–∫—Å–∞—Ü–∏–∏" (2PC) –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö. –°–æ–±—ã—Ç–∏–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –ë–î –≤ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —á—Ç–æ –∏ –±–∏–∑–Ω–µ—Å-–æ–ø–µ—Ä–∞—Ü–∏—è, —á—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –µ–≥–æ –Ω–∞–ª–∏—á–∏–µ.

---

## üõ°Ô∏è –ú–µ—Ö–∞–Ω–∏–∑–º—ã –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç–∏

| –ú–µ—Ö–∞–Ω–∏–∑–º | –ì–¥–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω | –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç |
|----------|----------------|----------------|
| **Circuit Breaker** | `event-relay/src/infrastructure/messaging/CircuitBreaker.ts` | –ó–∞—â–∏—â–∞–µ—Ç `KafkaProducerService` –æ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö —Å–±–æ–µ–≤ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏. –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞ –æ—à–∏–±–æ–∫ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `OPEN`, –±–ª–æ–∫–∏—Ä—É—è –≤—Å–µ –≤—ã–∑–æ–≤—ã –Ω–∞ –≤—Ä–µ–º—è. –ó–∞—Ç–µ–º –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ `HALF_OPEN` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏. |
| **DLQ (Dead Letter Queue)** | `event-relay/src/infrastructure/messaging/KafkaProducerService.ts` | –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ø–æ—Å–ª–µ `MAX_ATTEMPTS` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3), –æ–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–æ–ø–∏–∫ `*.dlq.v1` –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏ —Ä—É—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏. |
| **Health Checks** | –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã (`/health`) | –ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç `/health`, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–≤–æ–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–ë–î, Kafka, Redis). Docker Compose –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è `healthcheck`. |
| **Prometheus Metrics** | –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã | –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é—Ç –º–µ—Ç—Ä–∏–∫–∏ (latency, error rate, request count) –Ω–∞ –ø–æ—Ä—Ç `9091`/`9092`. Prometheus —Å–æ–±–∏—Ä–∞–µ—Ç –∏—Ö, Grafana —Å—Ç—Ä–æ–∏—Ç –¥–∞—à–±–æ—Ä–¥—ã. |
| **Structured Logging** | –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã | –õ–æ–≥–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É—é—Ç—Å—è –≤ JSON, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∏—Ö —Å ELK-—Å—Ç–µ–∫–æ–º –∏–ª–∏ Loki. |

---

## üìå –ó–∞–∫–ª—é—á–µ–Ω–∏–µ: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

–≠—Ç–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –∑—Ä–µ–ª—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤:

1. **–ß—ë—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**: –ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å —Ä–µ—à–∞–µ—Ç –æ–¥–Ω—É –∑–∞–¥–∞—á—É –∏ –Ω–µ –≤—Ç–æ—Ä–≥–∞–µ—Ç—Å—è –≤ –∑–æ–Ω—É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –¥—Ä—É–≥–∏—Ö.
2. **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π**: –ü–∞—Ç—Ç–µ—Ä–Ω Outbox + `event-relay` –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å –¥–∞–∂–µ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ—è—Ö Kafka –∏–ª–∏ —Ü–µ–ª–µ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.
3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã –∏ –º–æ–≥—É—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ. Kafka —Å–ª—É–∂–∏—Ç –±—É—Ñ–µ—Ä–æ–º, —Å–≥–ª–∞–∂–∏–≤–∞—é—â–∏–º –ø–∏–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏.
4. **–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Å–±–æ—è–º**: Circuit Breaker, DLQ –∏ health checks –ø–æ–∑–≤–æ–ª—è—é—Ç —Å–∏—Å—Ç–µ–º–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —á–∞—Å—Ç–∏—á–Ω–æ–º –æ—Ç–∫–∞–∑–µ.
5. **–ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å "–∏–∑ –∫–æ—Ä–æ–±–∫–∏"**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus/Grafana –∏ Kafka UI –¥–∞—ë—Ç –ø–æ–ª–Ω—É—é –≤–∏–¥–∏–º–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã.

–≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –Ω–∞–±–æ—Ä —Å–µ—Ä–≤–∏—Å–æ–≤, –∞ –ø—Ä–æ–¥—É–º–∞–Ω–Ω–∞—è, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–∞—è –∏ –≥–æ—Ç–æ–≤–∞—è –∫ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞.
