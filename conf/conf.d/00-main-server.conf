# Основные upstream
upstream auth_service {
    server auth-service:3000;
    keepalive 32;
}

upstream user_service {
    server user-service:3000;
    keepalive 32;
}

upstream bff_gateway {
    server bff-gateway:3000;
    keepalive 32;
}

upstream frontend {
    server frontend:5173;
    keepalive 32;
}

# Основной server блок - ТОЛЬКО ОДИН!
server {
    listen 80;
    server_name localhost platform.local;
    
    # Логирование
    access_log /var/log/nginx/api-gateway.access.log main;
    error_log /var/log/nginx/api-gateway.error.log warn;
    
    # Fix для proxy_headers_hash
    proxy_headers_hash_max_size 1024;
    proxy_headers_hash_bucket_size 128;
    
    # Заголовки безопасности
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Включаем все location из отдельных файлов
    include /etc/nginx/conf.d/10-auth-service.conf;
    include /etc/nginx/conf.d/20-user-service.conf;
    include /etc/nginx/conf.d/30-bff-gateway.conf;
    include /etc/nginx/conf.d/40-frontend.conf;
    include /etc/nginx/conf.d/50-security.conf;
    include /etc/nginx/conf.d/55-cors.conf;
    include /etc/nginx/conf.d/60-common.conf;
}