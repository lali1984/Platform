# ==================== BFF GATEWAY ====================
location /api/ {
    # Все остальные API запросы идут в BFF
    rewrite ^/api/(.*) /$1 break;
    
    proxy_pass http://bff_gateway;
    include /etc/nginx/proxy_params;
    
    # Дополнительные заголовки
    proxy_set_header X-Original-URI $request_uri;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # Rate limiting
    limit_req zone=api burst=30 nodelay;
    limit_req_status 429;
    
    # Кэширование для GET запросов
    proxy_cache api_cache;
    proxy_cache_valid 200 30s;
    proxy_cache_key "$scheme$request_method$host$uri$is_args$args";
    proxy_cache_bypass $http_cache_control;
    proxy_no_cache $http_pragma $http_authorization;
    add_header X-Cache-Status $upstream_cache_status always;
    
}
